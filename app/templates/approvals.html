{% extends "base.html" %}

{% block title %}Approvals - SupplyChainX{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3 mb-0">Approvals</h1>
            <p class="text-muted">Review and approve pending actions</p>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-4" id="approvalTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab">
                Pending <span class="badge bg-danger ms-1" id="pendingCount">...</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed" type="button" role="tab">
                Completed <span class="badge bg-secondary ms-1" id="completedCount">...</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="policies-tab" data-bs-toggle="tab" data-bs-target="#policies" type="button" role="tab">
                Policies Triggered <span class="badge bg-warning ms-1" id="policiesCount">...</span>
            </button>
        </li>
        <li class="nav-item ms-auto" role="presentation">
            <button class="btn btn-outline-success btn-sm" onclick="refreshApprovals()" id="refreshBtn">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="approvalTabContent">
        <!-- Pending Tab -->
        <div class="tab-pane fade show active" id="pending" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    <div id="pendingApprovalsContainer">
                        <!-- Loading spinner -->
                        <div class="text-center py-3">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading pending approvals...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Completed Tab -->
        <div class="tab-pane fade" id="completed" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    <div id="completedApprovalsContainer">
                        <!-- Loading spinner -->
                        <div class="text-center py-3">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading completed approvals...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Policies Triggered Tab -->
        <div class="tab-pane fade" id="policies" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    <div id="policiesTriggeredContainer">
                        <!-- Loading spinner -->
                        <div class="text-center py-3">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading triggered policies...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Approval Details Modal -->
<div class="modal fade" id="approvalDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Approval Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger">Reject</button>
                <button type="button" class="btn btn-success">Approve</button>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize page when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    loadPendingApprovals();
    
    // Set up real-time updates (every 30 seconds)
    setInterval(refreshApprovals, 30000);
    
    // Set up WebSocket connection for real-time updates
    if (typeof socket !== 'undefined') {
        socket.on('approval_update', function(data) {
            refreshApprovals();
        });
        
        socket.on('policy_trigger', function(data) {
            loadPoliciesTriggered();
        });
    }
    
    // Load data when tabs are shown
    document.getElementById('completed-tab').addEventListener('shown.bs.tab', function() {
        loadCompletedApprovals();
    });
    
    document.getElementById('policies-tab').addEventListener('shown.bs.tab', function() {
        loadPoliciesTriggered();
    });
});

function loadPendingApprovals() {
    fetch('/api/approvals/pending')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderPendingApprovals(data.approvals);
                document.getElementById('pendingCount').textContent = data.approvals.length;
            }
        })
        .catch(error => {
            console.error('Error loading pending approvals:', error);
            document.getElementById('pendingApprovalsContainer').innerHTML = 
                '<div class="alert alert-danger">Failed to load pending approvals</div>';
        });
}

function loadCompletedApprovals() {
    fetch('/api/approvals/history')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderCompletedApprovals(data.approvals);
                document.getElementById('completedCount').textContent = data.total_count;
            }
        })
        .catch(error => {
            console.error('Error loading completed approvals:', error);
            document.getElementById('completedApprovalsContainer').innerHTML = 
                '<div class="alert alert-danger">Failed to load completed approvals</div>';
        });
}

function loadPoliciesTriggered() {
    fetch('/api/policies/triggers')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderPoliciesTriggered(data.triggers);
                document.getElementById('policiesCount').textContent = data.triggers.length;
            }
        })
        .catch(error => {
            console.error('Error loading policy triggers:', error);
            document.getElementById('policiesTriggeredContainer').innerHTML = 
                '<div class="alert alert-danger">Failed to load policy triggers</div>';
        });
}

function renderPendingApprovals(approvals) {
    const container = document.getElementById('pendingApprovalsContainer');
    
    if (approvals.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No pending approvals</div>';
        return;
    }
    
    const tableHtml = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Type</th>
                        <th>Reason/Policy</th>
                        <th>Requested By</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${approvals.map(approval => `
                        <tr>
                            <td>
                                <strong>${approval.title}</strong><br>
                                <small class="text-muted">${approval.description || ''}</small>
                            </td>
                            <td><span class="badge bg-${getTypeColor(approval.decision_type)}">${approval.decision_type}</span></td>
                            <td>${approval.approval_reason || approval.policy_triggered || 'Manual Review'}</td>
                            <td>${approval.assigned_to || 'System'}</td>
                            <td>${formatTimeAgo(approval.created_at)}</td>
                            <td>
                                <button class="btn btn-sm btn-success" onclick="approveItem(${approval.id})">
                                    Approve
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="rejectItem(${approval.id})">
                                    Reject
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewDetails(${approval.id})">
                                    Details
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = tableHtml;
}

function renderCompletedApprovals(approvals) {
    const container = document.getElementById('completedApprovalsContainer');
    
    if (approvals.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No completed approvals</div>';
        return;
    }
    
    const tableHtml = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Type</th>
                        <th>Decision</th>
                        <th>Decided By</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${approvals.map(approval => `
                        <tr>
                            <td>
                                <strong>${approval.title}</strong><br>
                                <small class="text-muted">${approval.description || ''}</small>
                            </td>
                            <td><span class="badge bg-${getTypeColor(approval.decision_type)}">${approval.decision_type}</span></td>
                            <td><span class="badge bg-${approval.status === 'approved' ? 'success' : 'danger'}">${approval.status}</span></td>
                            <td>${approval.assigned_to || 'System'}</td>
                            <td>${formatTimeAgo(approval.resolved_at || approval.updated_at)}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewAudit(${approval.id})">
                                    View Audit
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = tableHtml;
}

function renderPoliciesTriggered(triggers) {
    const container = document.getElementById('policiesTriggeredContainer');
    
    if (triggers.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No active policy triggers</div>';
        return;
    }
    
    const html = `
        <h5>Active Policy Triggers</h5>
        ${triggers.map(trigger => `
            <div class="alert alert-${getPolicyAlertClass(trigger.priority)}">
                <h6 class="alert-heading">${trigger.policy_name}</h6>
                <p class="mb-0">${trigger.conditions}</p>
                <small class="text-muted">Last triggered: ${formatTimeAgo(trigger.last_triggered)}</small>
            </div>
        `).join('')}
    `;
    
    container.innerHTML = html;
}

function getTypeColor(type) {
    const colors = {
        'Route Change': 'info',
        'Purchase Order': 'success',
        'Inventory': 'warning',
        'shipment': 'info',
        'purchase_order': 'success',
        'recommendation': 'primary'
    };
    return colors[type] || 'secondary';
}

function getPolicyAlertClass(priority) {
    const classes = {
        'high': 'danger',
        'medium': 'warning',
        'low': 'info'
    };
    return classes[priority] || 'secondary';
}

function formatTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins} min ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
    if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
    
    return date.toLocaleDateString();
}

function refreshApprovals() {
    const activeTab = document.querySelector('.nav-link.active').id;
    
    if (activeTab === 'pending-tab') {
        loadPendingApprovals();
    } else if (activeTab === 'completed-tab') {
        loadCompletedApprovals();
    } else if (activeTab === 'policies-tab') {
        loadPoliciesTriggered();
    }
    
    // Update refresh button animation
    const refreshBtn = document.getElementById('refreshBtn');
    refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Refreshing...';
    setTimeout(() => {
        refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh';
    }, 1000);
}

function approveItem(id) {
    if (confirm('Are you sure you want to approve this item?')) {
        setLoadingState(true);
        
        fetch(`/api/approvals/${id}/approve`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Success', 'Item approved successfully', 'success');
                loadPendingApprovals();
            } else {
                showToast('Error', data.message || 'Failed to approve item', 'error');
            }
        })
        .catch(error => {
            console.error('Error approving item:', error);
            showToast('Error', 'Failed to approve item', 'error');
        })
        .finally(() => {
            setLoadingState(false);
        });
    }
}

function rejectItem(id) {
    const reason = prompt('Please provide a reason for rejecting this item:');
    if (reason) {
        setLoadingState(true);
        
        fetch(`/api/approvals/${id}/reject`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ reason: reason })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Success', 'Item rejected successfully', 'info');
                loadPendingApprovals();
            } else {
                showToast('Error', data.message || 'Failed to reject item', 'error');
            }
        })
        .catch(error => {
            console.error('Error rejecting item:', error);
            showToast('Error', 'Failed to reject item', 'error');
        })
        .finally(() => {
            setLoadingState(false);
        });
    }
}

function viewDetails(id) {
    fetch(`/api/approvals/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showDetailsModal(data.approval);
            } else {
                showToast('Error', 'Failed to load approval details', 'error');
            }
        })
        .catch(error => {
            console.error('Error loading approval details:', error);
            showToast('Error', 'Failed to load approval details', 'error');
        });
}

function showDetailsModal(approval) {
    const modal = document.getElementById('approvalDetailsModal');
    const modalBody = modal.querySelector('.modal-body');
    
    modalBody.innerHTML = `
        <h6>Item Details</h6>
        <p><strong>Title:</strong> ${approval.title}</p>
        <p><strong>Type:</strong> ${approval.decision_type}</p>
        <p><strong>Description:</strong> ${approval.description || 'No description available'}</p>
        
        <h6>Approval Information</h6>
        <p><strong>Reason:</strong> ${approval.approval_reason || approval.policy_triggered || 'Manual Review'}</p>
        <p><strong>Priority:</strong> ${approval.priority}</p>
        <p><strong>Status:</strong> ${approval.status}</p>
        <p><strong>Created:</strong> ${new Date(approval.created_at).toLocaleString()}</p>
        
        <h6>Context Data</h6>
        <pre class="bg-light p-2 rounded">${approval.context_data || 'No additional context available'}</pre>
    `;
    
    // Update modal footer buttons
    const footer = modal.querySelector('.modal-footer');
    const approveBtn = footer.querySelector('.btn-success');
    const rejectBtn = footer.querySelector('.btn-danger');
    
    if (approval.status === 'pending') {
        approveBtn.style.display = 'inline-block';
        rejectBtn.style.display = 'inline-block';
        approveBtn.onclick = () => {
            approveItem(approval.id);
            bootstrap.Modal.getInstance(modal).hide();
        };
        rejectBtn.onclick = () => {
            rejectItem(approval.id);
            bootstrap.Modal.getInstance(modal).hide();
        };
    } else {
        approveBtn.style.display = 'none';
        rejectBtn.style.display = 'none';
    }
    
    const detailsModal = new bootstrap.Modal(modal);
    detailsModal.show();
}

function viewAudit(id) {
    fetch(`/api/approvals/audit-trail?item_id=${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAuditModal(data.audit_trail);
            } else {
                showToast('Error', 'Failed to load audit trail', 'error');
            }
        })
        .catch(error => {
            console.error('Error loading audit trail:', error);
            showToast('Error', 'Failed to load audit trail', 'error');
        });
}

function showAuditModal(auditTrail) {
    const modal = `
        <div class="modal fade" id="auditModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Audit Trail</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="timeline">
                            ${auditTrail.map(entry => `
                                <div class="timeline-item mb-3">
                                    <div class="d-flex">
                                        <div class="flex-shrink-0">
                                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                <i class="bi bi-person-fill text-white"></i>
                                            </div>
                                        </div>
                                        <div class="flex-grow-1 ms-3">
                                            <h6 class="mb-1">${entry.action}</h6>
                                            <p class="mb-1">${entry.description}</p>
                                            <small class="text-muted">By ${entry.user} on ${new Date(entry.timestamp).toLocaleString()}</small>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modal);
    const auditModal = new bootstrap.Modal(document.getElementById('auditModal'));
    auditModal.show();
    
    // Clean up modal after hiding
    document.getElementById('auditModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

function setLoadingState(loading) {
    // Disable all action buttons during loading
    const buttons = document.querySelectorAll('.btn-success, .btn-outline-danger, .btn-outline-primary');
    buttons.forEach(btn => {
        btn.disabled = loading;
    });
}

// CSS for loading animation
const style = document.createElement('style');
style.textContent = `
    .spin {
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    .timeline-item {
        position: relative;
    }
    .timeline-item::before {
        content: '';
        position: absolute;
        left: 16px;
        top: 40px;
        height: calc(100% - 8px);
        width: 2px;
        background-color: #dee2e6;
    }
    .timeline-item:last-child::before {
        display: none;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
