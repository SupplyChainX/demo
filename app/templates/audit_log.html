{% extends "base.html" %}

{% block title %}Audit Log - SupplyChainX{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Audit Log</h1>
        <button class="btn btn-primary" onclick="exportAuditLog()">
            <i class="bi bi-download"></i> Export
        </button>
    </div>
    
    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="filterForm" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Date Range</label>
                    <select class="form-select" id="dateRange">
                        <option value="">All time</option>
                        <option value="today">Today</option>
                        <option value="week">Last 7 days</option>
                        <option value="month">Last 30 days</option>
                        <option value="custom">Custom range</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Actor Type</label>
                    <select class="form-select" id="actorType">
                        <option value="">All</option>
                        <option value="user">User</option>
                        <option value="agent">Agent</option>
                        <option value="system">System</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Action</label>
                    <select class="form-select" id="actionType">
                        <option value="">All</option>
                        <option value="create">Create</option>
                        <option value="update">Update</option>
                        <option value="delete">Delete</option>
                        <option value="approve">Approve</option>
                        <option value="reject">Reject</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Object Type</label>
                    <select class="form-select" id="objectType">
                        <option value="">All</option>
                        <option value="shipment">Shipment</option>
                        <option value="purchase_order">Purchase Order</option>
                        <option value="alert">Alert</option>
                        <option value="recommendation">Recommendation</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Result</label>
                    <select class="form-select" id="result">
                        <option value="">All</option>
                        <option value="success">Success</option>
                        <option value="failure">Failure</option>
                    </select>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Apply</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Audit Log Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table" id="auditTable">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Actor</th>
                            <th>Action</th>
                            <th>Object</th>
                            <th>Details</th>
                            <th>IP Address</th>
                            <th>Result</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Populated via JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <nav>
                <ul class="pagination justify-content-center" id="pagination">
                    <!-- Populated via JavaScript -->
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Detail Modal -->
<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Audit Log Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailContent">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    let currentFilters = {};
    
    document.addEventListener('DOMContentLoaded', function() {
        loadAuditLog();
    });
    
    document.getElementById('filterForm').addEventListener('submit', function(e) {
        e.preventDefault();
        currentPage = 1;
        loadAuditLog();
    });
    
    document.getElementById('dateRange').addEventListener('change', function() {
        if (this.value === 'custom') {
            // Show date picker modal
            showCustomDatePicker();
        }
    });
    
    function loadAuditLog(page = 1) {
        currentPage = page;
        
        // Collect filters
        currentFilters = {
            date_range: document.getElementById('dateRange').value,
            actor_type: document.getElementById('actorType').value,
            action_type: document.getElementById('actionType').value,
            object_type: document.getElementById('objectType').value,
            result: document.getElementById('result').value,
            page: currentPage
        };
        
        // Add loading state
        const tbody = document.querySelector('#auditTable tbody');
        tbody.innerHTML = '<tr><td colspan="8" class="text-center"><div class="spinner-border"></div></td></tr>';
        
        fetch('/api/audit?' + new URLSearchParams(currentFilters))
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.logs) {
                    updateAuditTable(data.logs);
                    updatePagination(data.total_pages || 1, data.current_page || 1);
                } else {
                    updateAuditTable([]);
                    updatePagination(1, 1);
                }
            })
            .catch(error => {
                console.error('Error loading audit log:', error);
                updateAuditTable([]);
                updatePagination(1, 1);
                showToast('Error', 'Failed to load audit log: ' + error.message, 'error');
            });
    }
    
    function updateAuditTable(logs) {
        const tbody = document.querySelector('#auditTable tbody');
        
        if (!logs || logs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No audit logs found</td></tr>';
            return;
        }
        
        tbody.innerHTML = logs.map(log => `
            <tr>
                <td>${formatDateTime(log.timestamp)}</td>
                <td>
                    <span class="badge bg-${getActorBadgeClass(log.actor_type)}">
                        ${log.actor_type}
                    </span>
                    <br>
                    <small>${log.actor_name || log.actor_id}</small>
                </td>
                <td>
                    <span class="badge bg-${getActionBadgeClass(log.action)}">
                        ${log.action}
                    </span>
                </td>
                <td>
                    ${log.object_type}<br>
                    <small class="text-muted">#${log.object_id}</small>
                </td>
                <td>
                    <span class="text-truncate d-inline-block" style="max-width: 200px;">
                        ${log.details || '-'}
                    </span>
                </td>
                <td>${log.ip_address || '-'}</td>
                <td>
                    <span class="badge bg-${log.result === 'success' ? 'success' : 'danger'}">
                        ${log.result}
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewDetails(${log.id})">
                        Details
                    </button>
                </td>
            </tr>
        `).join('');
    }
    
    function getActorBadgeClass(actorType) {
        const classes = {
            'user': 'primary',
            'agent': 'info',
            'system': 'secondary'
        };
        return classes[actorType] || 'secondary';
    }
    
    function getActionBadgeClass(action) {
        const classes = {
            'create': 'success',
            'update': 'warning',
            'delete': 'danger',
            'approve': 'primary',
            'reject': 'danger'
        };
        return classes[action] || 'secondary';
    }
    
    function updatePagination(totalPages, currentPage) {
        const pagination = document.getElementById('pagination');
        
        if (totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }
        
        let html = '';
        
        // Previous button
        html += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadAuditLog(${currentPage - 1})">Previous</a>
            </li>
        `;
        
        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadAuditLog(${i})">${i}</a>
                    </li>
                `;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
        }
        
        // Next button
        html += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadAuditLog(${currentPage + 1})">Next</a>
            </li>
        `;
        
        pagination.innerHTML = html;
    }
    
    function viewDetails(logId) {
        fetch(`/api/audit/${logId}`)
            .then(response => response.json())
            .then(log => {
                const content = document.getElementById('detailContent');
                content.innerHTML = `
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="text-muted">Timestamp</label>
                            <p>${formatDateTime(log.timestamp)}</p>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted">Request ID</label>
                            <p><code>${log.request_id || '-'}</code></p>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted">Actor</label>
                            <p>${log.actor_type}: ${log.actor_name || log.actor_id}</p>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted">IP Address</label>
                            <p>${log.ip_address || '-'}</p>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted">Action</label>
                            <p><span class="badge bg-${getActionBadgeClass(log.action)}">${log.action}</span></p>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted">Object</label>
                            <p>${log.object_type} #${log.object_id}</p>
                        </div>
                        <div class="col-12">
                            <label class="text-muted">Details</label>
                            <p>${log.details || 'No additional details'}</p>
                        </div>
                        ${log.before_value ? `
                            <div class="col-md-6">
                                <label class="text-muted">Before</label>
                                <pre class="bg-light p-2">${JSON.stringify(log.before_value, null, 2)}</pre>
                            </div>
                        ` : ''}
                        ${log.after_value ? `
                            <div class="col-md-6">
                                <label class="text-muted">After</label>
                                <pre class="bg-light p-2">${JSON.stringify(log.after_value, null, 2)}</pre>
                            </div>
                        ` : ''}
                        ${log.policy_checks ? `
                            <div class="col-12">
                                <label class="text-muted">Policy Checks</label>
                                <ul>
                                    ${log.policy_checks.map(check => `
                                        <li>
                                            ${check.policy_name}: 
                                            <span class="badge bg-${check.passed ? 'success' : 'danger'}">
                                                ${check.passed ? 'Passed' : 'Failed'}
                                            </span>
                                            ${check.reason ? `- ${check.reason}` : ''}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                const modal = new bootstrap.Modal(document.getElementById('detailModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error loading details:', error);
                showToast('Error', 'Failed to load details', 'error');
            });
    }
    
    function exportAuditLog() {
        const params = new URLSearchParams(currentFilters);
        params.append('format', 'csv');
        params.delete('page'); // Export all pages
        
        window.location.href = `/api/audit/export?${params}`;
    }
    
    function formatDateTime(dateString) {
        return new Date(dateString).toLocaleString();
    }
    
    function showToast(title, message, type = 'info') {
        // Simple toast implementation using alert for now
        // In a production app, you'd use Bootstrap toasts or a proper notification library
        console.log(`${type.toUpperCase()}: ${title} - ${message}`);
        if (type === 'error') {
            alert(`Error: ${message}`);
        }
    }
</script>
{% endblock %}
